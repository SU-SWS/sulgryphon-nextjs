
additionalRepositories:
  - url: https://github.com/SU-SWS/ace-stanfordlagunita/
    checkoutLocation: back
checkoutLocation: front
ports:
  - name: database
    description: Mysql database
    port: 3306
    onOpen: ignore
    visibility: private
  - port: 33060
    onOpen: ignore
    visibility: private
  - name: drupal
    description: Drupal backend
    port: 8001
    onOpen: ignore
    visibility: public
  - name: frontend
    description: NextJS frontend
    port: 3000
    onOpen: ignore
    visibility: public
  - port: 8002-9999
    onOpen: ignore
image: pookmish/drupal8ci:gitpod
tasks:
  - name: Drupal Prep
    init: >
      eval $(gp env -e APACHE_DOCROOT_IN_REPO=../back/docroot) &&
      cd /workspace/back &&
      git checkout 2.x &&
      composer install --no-interaction &&
      mkdir -p blt &&
      cp .gitpod/blt.yml blt/local.blt.yml &&
      find docroot/sites/ -name 'local*' | xargs rm -rf &&
      export NEXT_PUBLIC_DRUPAL_BASE_URL=`gp url 8001` &&
      export PREVIEW_URL=${NEXT_PUBLIC_DRUPAL_BASE_URL#"https://"} &&
      blt blt:telemetry:disable --no-interaction &&
      blt settings &&
      blt drupal:install --site=library -n &&
      drush @library.local cset system.theme default stanford_profile_admin_theme -y &&
      cd /workspace/front &&
      cp .env.example .env.local &&
      sed -i 's/#DRUPAL_REVALIDATE_SECRET/DRUPAL_REVALIDATE_SECRET/' .env.local &&
      sed -i 's/#DRUPAL_PREVIEW_SECRET/DRUPAL_PREVIEW_SECRET/' .env.local &&
      yarn install
    command: |
      eval $(gp env -e APACHE_DOCROOT_IN_REPO=../back/docroot) &&
      cd /workspace/back &&
      find docroot -name 'local.drush.yml' | xargs rm &&
      export NEXT_PUBLIC_DRUPAL_BASE_URL=`gp url 8001` &&
      export PREVIEW_URL=${NEXT_PUBLIC_DRUPAL_BASE_URL#"https://"} &&
      echo "<?php \$sites['$PREVIEW_URL'] = 'library';" > docroot/sites/local.sites.php &&
      blt settings &&
      apache2ctl restart &&
      gp ports await 8001 &&
      drush @library.local uli --uri=$NEXT_PUBLIC_DRUPAL_BASE_URL &&
      drush @library.local uli --uri=$NEXT_PUBLIC_DRUPAL_BASE_URL | xargs gp preview --external &&
      git config core.fileMode false &&
      echo 'Connecting Drupal to Frontend' &&
      drush @library.local su-next-connect "$(gp url 3000)" --preview-secret=DRUPAL_PREVIEW_SECRET --revalidation-secret=DRUPAL_REVALIDATION_SECRET &&
      cd /workspace/front &&
      yarn install &&
      yarn config set --home enableTelemetry 0 &&
      yarn next telemetry disable &&
      sed -i -r "s|NEXT_PUBLIC_DRUPAL_BASE_URL.*|NEXT_PUBLIC_DRUPAL_BASE_URL=$NEXT_PUBLIC_DRUPAL_BASE_URL|g" .env.local &&
      yarn dev &
      gp ports await 3000 &&
      gp url 3000 | xargs gp preview --external
  - name: SSH Keys
    before: |
      git remote set-url origin $(echo $GITPOD_WORKSPACE_CONTEXT | jq -r .repository.cloneUrl | sed -E 's|^.*.com/(.*)$|git@github.com:\1|')
      mkdir -p ~/.ssh
      if [[ ! -z $SSH_PUBLIC_KEY  ]]; then
          echo $SSH_PUBLIC_KEY | base64 -d > ~/.ssh/id_rsa.pub && chmod 644 ~/.ssh/id_rsa.pub
      fi
      if [[ ! -z $SSH_PRIVATE_KEY ]]; then
          echo $SSH_PRIVATE_KEY | base64 -d > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      fi
      if [[ ! -z $GITCONFIG ]]; then
          echo $GITCONFIG | base64 -d > ~/.gitconfig && chmod 644 ~/.gitconfig
      fi

vscode:
  extensions:
    - bradlc.vscode-tailwindcss